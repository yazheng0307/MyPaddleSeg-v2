

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>PaddleSeg十分钟快速上手 &mdash; MyPaddleSeg 1 文档</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="PaddleSeg安装步骤" href="install.html" />
    <link rel="prev" title="欢迎使用PaddleSeg！" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> MyPaddleSeg
          

          
            
            <img src="_static/paddleseg.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">1. 快速了解PaddleSeg</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">PaddleSeg十分钟快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="install.html">PaddleSeg安装步骤</a></li>
</ul>
<p class="caption"><span class="caption-text">2. 数据准备与处理</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="data/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">3. PaddleSeg设计思想</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="design/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">4. 模型训练</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="train/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">5. 模型评估</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="evaluation/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">6. 模型导出</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="export/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">7. 模型部署</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deployment/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">8. API使用教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="API_Example.html">API应用案例</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis/index.html">API接口说明</a></li>
</ul>
<p class="caption"><span class="caption-text">9. 模型压缩量化</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="slim/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">10. 重要模块说明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module/README.html">待补充</a></li>
</ul>
<p class="caption"><span class="caption-text">11. 经典模型说明</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="models/unet.html">U-Net</a></li>
<li class="toctree-l1"><a class="reference internal" href="models/deeplabv3.html">DeepLab V3+</a></li>
<li class="toctree-l1"><a class="reference internal" href="models/ocrnet.html">OCRNet</a></li>
<li class="toctree-l1"><a class="reference internal" href="models/fascnn.html">Fast-SCNN</a></li>
</ul>
<p class="caption"><span class="caption-text">12. 产品实践解决方案</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="solution/README.html">待补充</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MyPaddleSeg</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>PaddleSeg十分钟快速上手</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/quick_start.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="paddleseg">
<h1>PaddleSeg十分钟快速上手<a class="headerlink" href="#paddleseg" title="永久链接至标题">¶</a></h1>
<p>下面以BiSeNetV2和医学视盘分割数据集为例介绍PaddleSeg的<strong>配置化驱动</strong>使用方式。如果想了解API调用的使用方法，可点击<a class="reference external" href="https://aistudio.baidu.com/aistudio/projectdetail/1340052">PaddleSeg高级教程</a>。</p>
<p>按以下几个步骤来介绍使用流程。</p>
<ol class="simple">
<li><p>准备环境：使用PaddleSeg的软件环境，具体包括安装Python和飞桨的版本号和如何下载PaddleSeg代码库等内容</p></li>
<li><p>数据说明：用户如何自定义数据集</p></li>
<li><p>模型训练：训练配置和启动训练命令</p></li>
<li><p>可视化训练过程：PaddleSeg提供了一系列展示训练过程的可视化工具</p></li>
<li><p>模型评估：评估模型效果</p></li>
<li><p>效果可视化：使用训练好的模型进行预测，同时对结果进行可视化</p></li>
<li><p>模型导出：如何导出可进行部署的模型</p></li>
<li><p>模型部署：快速使用Python实现高效部署</p></li>
</ol>
<p><strong>1. 环境安装与验证</strong></p>
<p><strong>1.1环境安装</strong></p>
<p>在使用PaddleSeg训练图像分割模型之前，用户需要完成如下任务：</p>
<ol class="simple">
<li><p>安装<a class="reference external" href="https://www.python.org/downloads/">Python3.6或更高版本</a>。</p></li>
<li><p>安装飞桨2.0或更高版本，具体安装方法请参见<a class="reference external" href="https://www.paddlepaddle.org.cn/install/quick">快速安装</a>。由于图像分割模型计算开销大，推荐在GPU版本的PaddlePaddle下使用PaddleSeg。</p></li>
<li><p>下载PaddleSeg的代码库。</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span># PaddleSeg的代码库下载，同时支持github源和gitee源，为了在国内网络环境更快下载，此处使用gitee源。  
#! git clone https://github.com/PaddlePaddle/PaddleSeg.git
! git clone https://gitee.com/paddlepaddle/PaddleSeg.git
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">cd</span> <span class="o">~/</span><span class="n">PaddleSeg</span><span class="o">/</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>#通过pip形式安装paddleseg库，不仅安装了代码运行的环境依赖，也安装了PaddleSeg的API
! pip install paddleseg
</pre></div>
</div>
<p><strong>1.2确认环境安装成功</strong></p>
<p>执行下面命令，并在PaddleSeg/output文件夹中出现预测结果，则证明安装成功</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>! python predict.py \
       --config configs/quick_start/bisenet_optic_disc_512x512_1k.yml \
       --model_path https://bj.bcebos.com/paddleseg/dygraph/optic_disc/bisenet_optic_disc_512x512_1k/model.pdparams\
       --image_path docs/images/optic_test_image.jpg \
       --save_dir output/result
</pre></div>
</div>
<p><strong>2. 数据集下载与说明</strong></p>
<p><strong>数据集下载</strong></p>
<p>本章节将使用视盘分割（optic disc segmentation）数据集进行训练，视盘分割是一组眼底医疗分割数据集，包含了267张训练图片、76张验证图片、38张测试图片。通过以下命令可以下载该数据集。</p>
<p>数据集的原图和效果图如下所示，任务是将眼球图片中的视盘区域分割出来。</p>
<p><img alt="_images/fig1.png" src="_images/fig1.png" /></p>
<p>​                                                                                            图1：数据集的原图和效果图</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>#下载并解压数据集
! mkdir dataset
%cd dataset
! wget https://paddleseg.bj.bcebos.com/dataset/optic_disc_seg.zip
! unzip optic_disc_seg.zip
%cd ..
</pre></div>
</div>
<p><strong>2.1数据集说明</strong></p>
<p>如何使用自己的数据集进行训练是开发者最关心的事情，下面我们将着重说明一下如果要自定义数据集，我们该准备成什么样子？数据集准备好，如何在配置文件中进行改动。</p>
<p><strong>2.1.1数据集说明</strong></p>
<ul>
<li><p>推荐整理成如下结构</p></li>
<li><p>文件夹命名为custom_dataset、images、labels不是必须，用户可以自主进行命名。</p></li>
<li><p>train.txt val.txt test.txt中文件并非要和custom_dataset文件夹在同一目录下，可以通过配置文件中的选项修改，但一般推荐整理成如下格式：</p>
<p>custom_dataset | |–images | |–image1.jpg | |–image2.jpg | |–… | |–labels | |–label1.png | |–label2.png | |–… | |–train.txt | |–val.txt | |–test.txt</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span> 其中train.txt和val.txt的内容如下所示：

 images/image1.jpg labels/label1.png
 images/image2.jpg labels/label2.png
 ...
</pre></div>
</div>
</li>
</ul>
<p>我们刚刚下载的数据集格式也与之类似(label.txt可有可以无)，如果用户要进行数据集标注和数据划分，请参考文档。</p>
<p>我们一般推荐用户将数据集放置在PaddleSeg下的dataset文件夹下。</p>
<p><strong>模型训练</strong></p>
<ul class="simple">
<li><p>本项目选择BiseNetV2模型，BiseNetV2是一个轻量化模型，在Cityscapes测试集中的平均IoU达到72.6％，在一张NVIDIA GeForce GTX 1080 Ti卡上的速度为156 FPS，这比现有方法要快得多，而且可以实现更好的分割精度。</p></li>
</ul>
<p><strong>3.1 BiseNetV2模型介绍</strong></p>
<p>双边分割网络(BiSeNet V2)，将低层次的网络细节和高层次的语义分类分开处理，以实现高精度和高效率的实时语义分割。它在速度和精度之间进行权衡。该体系结构包括：</p>
<p>(1)一个细节分支，具有浅层宽通道，用于捕获低层细节并生成高分辨率的特征表示。</p>
<p>(2)一个语义分支，通道窄，层次深，获取高层次语义语境。语义分支是轻量级的，因为它减少了通道容量和快速下采样策略。此外，设计了一个引导聚合层来增强相互连接和融合这两种类型的特征表示。此外，还设计了一种增强型训练策略，在不增加任何推理代价的情况下提高分割性能。</p>
<p><img alt="_images/fig2.png" src="_images/fig2.png" /></p>
<p>​                                                                                                          图2：数据集的原图和效果图</p>
<p><strong>3.2 配置文件详细解读</strong></p>
<p>在了解完BiseNetV2原理后，我们便可准备进行训练了。上文中我们谈到PaddleSeg提供了<strong>配置化驱动</strong>进行模型训练。那么在训练之前，先来了解一下配置文件，在这里我们以<code class="docutils literal notranslate"><span class="pre">bisenet_optic_disc_512x512_1k.yml</span></code>为例子说明，该yaml格式配置文件包括模型类型、骨干网络、训练和测试、预训练数据集和配套工具（如数据增强）等信息。</p>
<p>PaddleSeg在配置文件中详细列出了每一个可以优化的选项，用户只要修改这个配置文件就可以对模型进行定制（<strong>所有的配置文件在PaddleSeg/configs文件夹下面</strong>），如自定义模型使用的骨干网络、模型使用的损失函数以及关于网络结构等配置。除了定制模型之外，配置文件中还可以配置数据处理的策略，如改变尺寸、归一化和翻转等数据增强的策略。</p>
<p><strong>重点参数说明：</strong></p>
<ul class="simple">
<li><p>1：在PaddleSeg的配置文件给出的学习率中，除了”bisenet_optic_disc_512x512_1k.yml”中为单卡学习率外，其余配置文件中均为4卡的学习率，如果用户是单卡训练，则学习率设置应变成原来的1/4。</p></li>
<li><p>2：在PaddleSeg中的配置文件，给出了多种损失函数：CrossEntropy Loss、BootstrappedCrossEntropy Loss、Dice Loss、BCE Loss、OhemCrossEntropyLoss、RelaxBoundaryLoss、OhemEdgeAttentionLoss、Lovasz Hinge Loss、Lovasz Softmax Loss，用户可根据自身需求进行更改。</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span><span class="p">:</span> <span class="mi">4</span>  <span class="c1">#设定batch_size的值即为迭代一次送入网络的图片数量，一般显卡显存越大，batch_size的值可以越大</span>
<span class="n">iters</span><span class="p">:</span> <span class="mi">1000</span>    <span class="c1">#模型迭代的次数</span>

<span class="n">train_dataset</span><span class="p">:</span> <span class="c1">#训练数据设置</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">OpticDiscSeg</span> <span class="c1">#选择数据集格式</span>
  <span class="n">dataset_root</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">optic_disc_seg</span> <span class="c1">#选择数据集路径</span>
  <span class="n">num_classes</span><span class="p">:</span> <span class="mi">2</span> <span class="c1">#指定目标的类别个数（背景也算为一类）</span>
  <span class="n">transforms</span><span class="p">:</span> <span class="c1">#数据预处理/增强的方式</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Resize</span> <span class="c1">#送入网络之前需要进行resize</span>
      <span class="n">target_size</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span> <span class="c1">#将原图resize成512*512在送入网络</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">RandomHorizontalFlip</span> <span class="c1">#采用水平反转的方式进行数据增强</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Normalize</span> <span class="c1">#图像进行归一化</span>
  <span class="n">mode</span><span class="p">:</span> <span class="n">train</span>

<span class="n">val_dataset</span><span class="p">:</span> <span class="c1">#验证数据设置</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">OpticDiscSeg</span> <span class="c1">#选择数据集格式</span>
  <span class="n">dataset_root</span><span class="p">:</span> <span class="n">data</span><span class="o">/</span><span class="n">optic_disc_seg</span> <span class="c1">#选择数据集路径</span>
  <span class="n">num_classes</span><span class="p">:</span> <span class="mi">2</span> <span class="c1">#指定目标的类别个数（背景也算为一类）</span>
  <span class="n">transforms</span><span class="p">:</span> <span class="c1">#数据预处理/增强的方式</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Resize</span>  <span class="c1">#将原图resize成512*512在送入网络</span>
      <span class="n">target_size</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>  <span class="c1">#将原图resize成512*512在送入网络</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Normalize</span> <span class="c1">#图像进行归一化</span>
  <span class="n">mode</span><span class="p">:</span> <span class="n">val</span>

<span class="n">optimizer</span><span class="p">:</span> <span class="c1">#设定优化器的类型</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">sgd</span> <span class="c1">#采用SGD（Stochastic Gradient Descent）随机梯度下降方法为优化器</span>
  <span class="n">momentum</span><span class="p">:</span> <span class="mf">0.9</span> <span class="c1">#动量</span>
  <span class="n">weight_decay</span><span class="p">:</span> <span class="mf">4.0e-5</span> <span class="c1">#权值衰减，使用的目的是防止过拟合</span>

<span class="n">learning_rate</span><span class="p">:</span> <span class="c1">#设定学习率</span>
  <span class="n">value</span><span class="p">:</span> <span class="mf">0.01</span>  <span class="c1">#初始学习率</span>
  <span class="n">decay</span><span class="p">:</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">poly</span>  <span class="c1">#采用poly作为学习率衰减方式。</span>
    <span class="n">power</span><span class="p">:</span> <span class="mf">0.9</span>  <span class="c1">#衰减率</span>
    <span class="n">end_lr</span><span class="p">:</span> <span class="mi">0</span>   <span class="c1">#最终学习率</span>

<span class="n">loss</span><span class="p">:</span> <span class="c1">#设定损失函数的类型</span>
  <span class="n">types</span><span class="p">:</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">CrossEntropyLoss</span> <span class="c1">#损失函数类型</span>
  <span class="n">coef</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
  <span class="c1">#BiseNetV2有4个辅助loss，加上主loss共五个，1表示权重 all_loss = coef_1 * loss_1 + .... + coef_n * loss_n</span>

<span class="n">model</span><span class="p">:</span> <span class="c1">#模型说明</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">BiSeNetV2</span>  <span class="c1">#设定模型类别</span>
  <span class="n">pretrained</span><span class="p">:</span> <span class="n">Null</span> <span class="c1">#设定模型的预训练模型</span>
</pre></div>
</div>
<p><strong>FAQ</strong></p>
<p>Q：有的读者可能会有疑问，什么样的配置项是设计在配置文件中，什么样的配置项在脚本的命令行参数呢？</p>
<p>A：与模型方案相关的信息均在配置文件中，还包括对原始样本的数据增强策略等。除了iters、batch_size、learning_rate3种常见参数外，命令行参数仅涉及对训练过程的配置。也就是说，配置文件最终决定了使用什么模型。</p>
<p><strong>3.3 修改配置文件中对应的数据配置</strong></p>
<p>当用户准备好数据集后，可以在配置文件中指定位置修改数据路径来进行进一步的训练</p>
<p>在这里，我们还是以上文中谈到的”bisenet_optic_disc_512x512_1k.yml”文件为例，摘选出数据配置部分为大家说明。</p>
<p>主要关注这几个参数：</p>
<ul class="simple">
<li><p>type的参数是Dataset，代表的是建议的数据格式；</p></li>
<li><p>dataset_root路径为包含label和image所在的路径；在示例中为：dataset_root: dataset/optic_disc_seg</p></li>
<li><p>train_path为txt的路径；在示例中为：train_path: dataset/optic_disc_seg/train_list.txt</p></li>
<li><p>num_classes为类别（背景也算为一类）；</p></li>
<li><p>transform是对数据的预处理的策略，用户可根据自己的实际需要改动</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">Dataset</span>
  <span class="n">dataset_root</span><span class="p">:</span> <span class="n">dataset</span><span class="o">/</span><span class="n">optic_disc_seg</span>
  <span class="n">train_path</span><span class="p">:</span> <span class="n">dataset</span><span class="o">/</span><span class="n">optic_disc_seg</span><span class="o">/</span><span class="n">train_list</span><span class="o">.</span><span class="n">txt</span>
  <span class="n">num_classes</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">transforms</span><span class="p">:</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Resize</span>
      <span class="n">target_size</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">RandomHorizontalFlip</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Normalize</span>
  <span class="n">mode</span><span class="p">:</span> <span class="n">train</span>

<span class="n">val_dataset</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">Dataset</span>
  <span class="n">dataset_root</span><span class="p">:</span> <span class="n">dataset</span><span class="o">/</span><span class="n">optic_disc_seg</span>
  <span class="n">val_path</span><span class="p">:</span> <span class="n">dataset</span><span class="o">/</span><span class="n">optic_disc_seg</span><span class="o">/</span><span class="n">val_list</span><span class="o">.</span><span class="n">txt</span>
  <span class="n">num_classes</span><span class="p">:</span> <span class="mi">2</span>
  <span class="n">transforms</span><span class="p">:</span>
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Resize</span>  
      <span class="n">target_size</span><span class="p">:</span> <span class="p">[</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">]</span>  
    <span class="o">-</span> <span class="nb">type</span><span class="p">:</span> <span class="n">Normalize</span>
  <span class="n">mode</span><span class="p">:</span> <span class="n">val</span>
</pre></div>
</div>
<p><strong>3.4 正式开启训练</strong></p>
<p>当我们修改好对应的配置参数后，就可以上手体验使用了</p>
<p>In [6]</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!export CUDA_VISIBLE_DEVICES=0 # 设置1张可用的卡

**windows下请执行以下命令**
**set CUDA_VISIBLE_DEVICES=0**
!python train.py \
       --config configs/quick_start/bisenet_optic_disc_512x512_1k.yml \
       --do_eval \
       --use_vdl \
       --save_interval 500 \
       --save_dir output
</pre></div>
</div>
<ul class="simple">
<li><p>结果文件</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>output
  ├── iter_500 #表示在500步保存一次模型
          ├── model.pdparams  #模型参数
          └── model.pdopt  #训练阶段的优化器参数
  ├── iter_1000
          ├── model.pdparams
          └── model.pdopt
  └── best_model #在训练的时候，训练时候增加--do_eval后，每保存一次模型，都会eval一次，miou最高的模型会被另存为best_model
          └── model.pdparams  
</pre></div>
</div>
<p><strong>3.5 训练参数解释</strong></p>
<p>| 参数名              | 用途                                                         | 是否必选项 | 默认值           |
| :—————— | :———————————————————– | :——— | :————— |
| iters               | 训练迭代次数                                                 | 否         | 配置文件中指定值 |
| batch_size          | 单卡batch size                                               | 否         | 配置文件中指定值 |
| learning_rate       | 初始学习率                                                   | 否         | 配置文件中指定值 |
| config              | 配置文件                                                     | 是         | -                |
| save_dir            | 模型和visualdl日志文件的保存根路径                           | 否         | output           |
| num_workers         | 用于异步读取数据的进程数量， 大于等于1时开启子进程读取数据   | 否         | 0                |
| use_vdl             | 是否开启visualdl记录训练数据                                 | 否         | 否               |
| save_interval_iters | 模型保存的间隔步数                                           | 否         | 1000             |
| do_eval             | 是否在保存模型时启动评估, 启动时将会根据mIoU保存最佳模型至best_model | 否         | 否               |
| log_iters           | 打印日志的间隔步数                                           | 否         | 10               |
| resume_model        | 恢复训练模型路径，如：<code class="docutils literal notranslate"><span class="pre">output/iter_1000</span></code>                     | 否         | None             |
| keep_checkpoint_max | 最新模型保存个数                                             | 否         | 5                |</p>
<p><strong>3.6 配置文件的深度探索</strong></p>
<ul class="simple">
<li><p>刚刚我们拿出一个BiSeNetV2的配置文件让大家去体验一下如何数据集配置，在这里例子中，所有的参数都放置在了一个yml文件中，但是实际PaddleSeg的配置文件为了具有更好的复用性和兼容性，采用了更加耦合的设计，即一个模型需要两个以上配置文件来实现，下面我们具体一DeeplabV3p为例子来为大家说明配置文件的耦合设置。</p></li>
<li><p>例如我们要更改deeplabv3p_resnet50_os8_cityscapes_1024x512_80k.yml 文件的配置，则会发现该文件还依赖（base）cityscapes.yml文件。此时，我们就需要同步打开 cityscapes.yml 文件进行相应参数的设置。</p></li>
</ul>
<p><img alt="_images/fig3.png" src="_images/fig3.png" /></p>
<p>​                                                                                                                图3：配置文件深入探索</p>
<p>在PaddleSeg2.0模式下，用户可以发现，PaddleSeg采用了更加耦合的配置设计，将数据、优化器、损失函数等共性的配置都放在了一个单独的配置文件下面，当我们尝试换新的网络结构的是时候，只需要关注模型切换即可，避免了切换模型重新调节这些共性参数的繁琐节奏，避免用户出错。</p>
<p><strong>FAQ</strong></p>
<p>Q：有些共同的参数，多个配置文件下都有，那么我以哪一个为准呢？</p>
<p>A：如图中序号所示，1号yml文件的参数可以覆盖2号yml文件的参数，即1号的配置文件优于2号文件</p>
<p><strong>3.7 多卡训练</strong></p>
<p><strong>注意</strong>：如果想要使用多卡训练的话，需要将环境变量CUDA_VISIBLE_DEVICES指定为多卡（不指定时默认使用所有的gpu)，并使用paddle.distributed.launch启动训练脚本（windows下由于不支持nccl，无法使用多卡训练）:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span> <span class="c1"># 设置4张可用的卡</span>
<span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">paddle</span><span class="o">.</span><span class="n">distributed</span><span class="o">.</span><span class="n">launch</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span> \
       <span class="o">--</span><span class="n">config</span> <span class="n">configs</span><span class="o">/</span><span class="n">quick_start</span><span class="o">/</span><span class="n">bisenet_optic_disc_512x512_1k</span><span class="o">.</span><span class="n">yml</span> \
       <span class="o">--</span><span class="n">do_eval</span> \
       <span class="o">--</span><span class="n">use_vdl</span> \
       <span class="o">--</span><span class="n">save_interval</span> <span class="mi">500</span> \
       <span class="o">--</span><span class="n">save_dir</span> <span class="n">output</span>
</pre></div>
</div>
<p><strong>3.8 恢复训练</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">train</span><span class="o">.</span><span class="n">py</span> \
       <span class="o">--</span><span class="n">config</span> <span class="n">configs</span><span class="o">/</span><span class="n">quick_start</span><span class="o">/</span><span class="n">bisenet_optic_disc_512x512_1k</span><span class="o">.</span><span class="n">yml</span> \
       <span class="o">--</span><span class="n">resume_model</span> <span class="n">output</span><span class="o">/</span><span class="n">iter_500</span> \
       <span class="o">--</span><span class="n">do_eval</span> \
       <span class="o">--</span><span class="n">use_vdl</span> \
       <span class="o">--</span><span class="n">save_interval</span> <span class="mi">500</span> \
       <span class="o">--</span><span class="n">save_dir</span> <span class="n">output</span>
</pre></div>
</div>
<p><strong>4. 训练过程可视化</strong></p>
<ul class="simple">
<li><p>为了更直观我们的网络训练过程，对网络进行分析从而更快速的得到更好的网络，飞桨提供了可视化分析工具：VisualDL</p></li>
</ul>
<p>当打开<code class="docutils literal notranslate"><span class="pre">use_vdl</span></code>开关后，PaddleSeg会将训练过程中的数据写入VisualDL文件，可实时查看训练过程中的日志。记录的数据包括：</p>
<ol class="simple">
<li><p>loss变化趋势</p></li>
<li><p>学习率变化趋势</p></li>
<li><p>训练时间</p></li>
<li><p>数据读取时间</p></li>
<li><p>mean IoU变化趋势（当打开了<code class="docutils literal notranslate"><span class="pre">do_eval</span></code>开关后生效）</p></li>
<li><p>mean pixel Accuracy变化趋势（当打开了<code class="docutils literal notranslate"><span class="pre">do_eval</span></code>开关后生效）</p></li>
</ol>
<p>使用如下命令启动VisualDL查看日志</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>**下述命令会在127.0.0.1上启动一个服务，支持通过前端web页面查看，可以通过--host这个参数指定实际ip地址**
visualdl --logdir output/
</pre></div>
</div>
<p>在浏览器输入提示的网址，效果如下：</p>
<p><img alt="_images/fig4.png" src="_images/fig4.png" /></p>
<p>​                                                                                    图4：VDL效果演示</p>
<p><strong>5. 模型评估</strong></p>
<p>训练完成后，用户可以使用评估脚本val.py来评估模型效果。假设训练过程中迭代次数（iters）为1000，保存模型的间隔为500，即每迭代1000次数据集保存2次训练模型。因此一共会产生2个定期保存的模型，加上保存的最佳模型best_model，一共有3个模型，可以通过model_path指定期望评估的模型文件。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!python val.py \
       --config configs/quick_start/bisenet_optic_disc_512x512_1k.yml \
       --model_path output/iter_1000/model.pdparams
</pre></div>
</div>
<p>如果想进行多尺度翻转评估可通过传入<code class="docutils literal notranslate"><span class="pre">--aug_eval</span></code>进行开启，然后通过<code class="docutils literal notranslate"><span class="pre">--scales</span></code>传入尺度信息， <code class="docutils literal notranslate"><span class="pre">--flip_horizontal</span></code>开启水平翻转， <code class="docutils literal notranslate"><span class="pre">flip_vertical</span></code>开启垂直翻转。使用示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">val</span><span class="o">.</span><span class="n">py</span> \
       <span class="o">--</span><span class="n">config</span> <span class="n">configs</span><span class="o">/</span><span class="n">quick_start</span><span class="o">/</span><span class="n">bisenet_optic_disc_512x512_1k</span><span class="o">.</span><span class="n">yml</span> \
       <span class="o">--</span><span class="n">model_path</span> <span class="n">output</span><span class="o">/</span><span class="n">iter_1000</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">pdparams</span> \
       <span class="o">--</span><span class="n">aug_eval</span> \
       <span class="o">--</span><span class="n">scales</span> <span class="mf">0.75</span> <span class="mf">1.0</span> <span class="mf">1.25</span> \
       <span class="o">--</span><span class="n">flip_horizontal</span>
</pre></div>
</div>
<p>如果想进行滑窗评估可通过传入<code class="docutils literal notranslate"><span class="pre">--is_slide</span></code>进行开启， 通过<code class="docutils literal notranslate"><span class="pre">--crop_size</span></code>传入窗口大小， <code class="docutils literal notranslate"><span class="pre">--stride</span></code>传入步长。使用示例如下：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">val</span><span class="o">.</span><span class="n">py</span> \
       <span class="o">--</span><span class="n">config</span> <span class="n">configs</span><span class="o">/</span><span class="n">quick_start</span><span class="o">/</span><span class="n">bisenet_optic_disc_512x512_1k</span><span class="o">.</span><span class="n">yml</span> \
       <span class="o">--</span><span class="n">model_path</span> <span class="n">output</span><span class="o">/</span><span class="n">iter_1000</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">pdparams</span> \
       <span class="o">--</span><span class="n">is_slide</span> \
       <span class="o">--</span><span class="n">crop_size</span> <span class="mi">256</span> <span class="mi">256</span> \
       <span class="o">--</span><span class="n">stride</span> <span class="mi">128</span> <span class="mi">128</span>
</pre></div>
</div>
<p>在图像分割领域中，评估模型质量主要是通过三个指标进行判断，准确率（acc）、平均交并比（Mean Intersection over Union，简称mIoU）、Kappa系数。</p>
<ul class="simple">
<li><p>准确率：指类别预测正确的像素占总像素的比例，准确率越高模型质量越好。</p></li>
<li><p>平均交并比：对每个类别数据集单独进行推理计算，计算出的预测区域和实际区域交集除以预测区域和实际区域的并集，然后将所有类别得到的结果取平均。在本例中，正常情况下模型在验证集上的mIoU指标值会达到0.80以上，显示信息示例如下所示，第3行的<strong>mIoU=0.8526</strong>即为mIoU。</p></li>
<li><p>Kappa系数：一个用于一致性检验的指标，可以用于衡量分类的效果。kappa系数的计算是基于混淆矩阵的，取值为-1到1之间，通常大于0。其公式如下所示，P0P_0<em>P</em>0为分类器的准确率，PeP_e<em>P**e</em>为随机分类器的准确率。Kappa系数越高模型质量越好。</p></li>
</ul>
<p>Kappa=P0−Pe1−PeKappa= \frac{P_0-P_e}{1-P_e}<em>K<strong>a</strong>p<strong>p</strong>a</em>=1−<em>P<strong>e</strong>P</em>0−<em>P**e</em></p>
<p>随着评估脚本的运行，最终打印的评估日志如下。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">29</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span>	<span class="n">Start</span> <span class="n">evaluating</span> <span class="p">(</span><span class="n">total_samples</span><span class="o">=</span><span class="mi">76</span><span class="p">,</span> <span class="n">total_iters</span><span class="o">=</span><span class="mi">76</span><span class="p">)</span><span class="o">...</span>
<span class="mi">76</span><span class="o">/</span><span class="mi">76</span> <span class="p">[</span><span class="o">==============================</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="n">s</span> <span class="mi">30</span><span class="n">ms</span><span class="o">/</span><span class="n">step</span> <span class="o">-</span> <span class="n">batch_cost</span><span class="p">:</span> <span class="mf">0.0268</span> <span class="o">-</span> <span class="n">reader</span> <span class="n">cost</span><span class="p">:</span> <span class="mf">1.7656</span><span class="n">e</span><span class="o">-</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">31</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span>	<span class="p">[</span><span class="n">EVAL</span><span class="p">]</span> <span class="c1">#Images=76 mIoU=0.8526 Acc=0.9942 Kappa=0.8283</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">31</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span>	<span class="p">[</span><span class="n">EVAL</span><span class="p">]</span> <span class="n">Class</span> <span class="n">IoU</span><span class="p">:</span>
<span class="p">[</span><span class="mf">0.9941</span> <span class="mf">0.7112</span><span class="p">]</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">13</span> <span class="mi">16</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">31</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span>	<span class="p">[</span><span class="n">EVAL</span><span class="p">]</span> <span class="n">Class</span> <span class="n">Acc</span><span class="p">:</span>
<span class="p">[</span><span class="mf">0.9959</span> <span class="mf">0.8886</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>6. 效果可视化</strong></p>
<p>除了分析模型的IOU、ACC和Kappa指标之外，我们还可以查阅一些具体样本的切割样本效果，从Bad Case启发进一步优化的思路。</p>
<p>predict.py脚本是专门用来可视化预测案例的，命令格式如下所示</p>
<p>In [8]</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>!python predict.py \
       --config configs/quick_start/bisenet_optic_disc_512x512_1k.yml \
       --model_path output/iter_1000/model.pdparams \
       --image_path dataset/optic_disc_seg/JPEGImages/H0003.jpg \
       --save_dir output/result
</pre></div>
</div>
<p>其中<code class="docutils literal notranslate"><span class="pre">image_path</span></code>也可以是一个目录，这时候将对目录内的所有图片进行预测并保存可视化结果图。</p>
<p>同样的，可以通过<code class="docutils literal notranslate"><span class="pre">--aug_pred</span></code>开启多尺度翻转预测， <code class="docutils literal notranslate"><span class="pre">--is_slide</span></code>开启滑窗预测。</p>
<p>我们选择1张图片进行查看，效果如下。我们可以直观的看到模型的切割效果和原始标记之间的差别，从而产生一些优化的思路，比如是否切割的边界可以做规则化的处理等。</p>
<p><img alt="_images/fig5.png" src="_images/fig5.png" /></p>
<p>​                                                                                                  图5：预测效果展示</p>
<p><strong>7 模型导出</strong></p>
<p>为了方便用户进行工业级的部署，PaddleSeg提供了一键动转静的功能，即将训练出来的动态图模型文件转化成静态图形式。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>! python export.py \
       --config configs/quick_start/bisenet_optic_disc_512x512_1k.yml \
       --model_path output/iter_1000/model.pdparams
</pre></div>
</div>
<ul class="simple">
<li><p>参数说明如下</p></li>
</ul>
<p>| 参数名     | 用途                               | 是否必选项 | 默认值           |
| :——— | :——————————— | :——— | :————— |
| config     | 配置文件                           | 是         | -                |
| save_dir   | 模型和visualdl日志文件的保存根路径 | 否         | output           |
| model_path | 预训练模型参数的路径               | 否         | 配置文件中指定值 |</p>
<ul class="simple">
<li><p>结果文件</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>output
  ├── deploy.yaml            # 部署相关的配置文件
  ├── model.pdiparams        # 静态图模型参数
  ├── model.pdiparams.info   # 参数额外信息，一般无需关注
  └── model.pdmodel          # 静态图模型文件
</pre></div>
</div>
<p><strong>8 应用部署</strong></p>
<ul class="simple">
<li><p>PaddleSeg目前支持以下部署方式：</p></li>
</ul>
<p>| 端侧         | 库           | 教程   |
| :———– | :———– | :—– |
| Python端部署 | Paddle预测库 | 已完善 |
| 移动端部署   | ONNX         | 完善中 |
| 服务端部署   | HubServing   | 完善中 |
| 前端部署     | PaddleJS     | 完善中 |</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>#运行如下命令，会在output文件下面生成一张H0003.png的图像
!python deploy/python/infer.py \
--config output/deploy.yaml\
--image_path dataset/optic_disc_seg/JPEGImages/H0003.jpg\
--save_dir output
</pre></div>
</div>
<ul class="simple">
<li><p>参数说明如下:</p></li>
</ul>
<p>| 参数名     | 用途                                                      | 是否必选项 | 默认值           |
| :——— | :——————————————————– | :——— | :————— |
| config     | <strong>导出模型时生成的配置文件</strong>, 而非configs目录下的配置文件 | 是         | -                |
| image_path | 预测图片的路径或者目录                                    | 是         | -                |
| use_trt    | 是否开启TensorRT来加速预测                                | 否         | 否               |
| use_int8   | 启动TensorRT预测时，是否以int8模式运行                    | 否         | 否               |
| batch_size | 单卡batch size                                            | 否         | 配置文件中指定值 |
| save_dir   | 保存预测结果的目录                                        | 否         | output           |</p>
<p><strong>9 二次开发</strong></p>
<ul class="simple">
<li><p>在尝试完成使用配置文件进行训练之后，肯定有小伙伴想基于PaddleSeg进行更深入的开发，在这里，我们大概介绍一下PaddleSeg代码结构，</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>PaddleSeg
     ├──  configs #配置文件文件夹
     ├──  paddleseg #训练部署的核心代码
              ├── core  
              ├── cvlibs #  Config类定义在该文件夹中。它保存了数据集、模型配置、主干网络、损失函数等所有的超参数。
                      ├── callbacks.py
                      └── ...
              ├── datasets #PaddleSeg支持的数据格式，包括ade、citycapes等多种格式
                      ├── ade.py
                      ├── citycapes.py
                      └── ...
              ├── models #该文件夹下包含了PaddleSeg组网的各个部分
                      ├── backbone # paddleseg的使用的主干网络
                                ├── hrnet.py
                                ├── resnet_vd.py
                                └── ...
                      ├── layers # 一些组件，例如attention机制
                                ├── activation.py
                                ├── attention.py
                                └── ...
                      ├── losses #该文件夹下包含了PaddleSeg所用到的损失函数
                                ├── dice_loss.py
                                ├── lovasz_loss.py
                                └── ...
                      ├── ann.py #该文件表示的是PaddleSeg所支持的算法模型，这里表示ann算法。
                      ├── deeplab.py #该文件表示的是PaddleSeg所支持的算法模型，这里表示Deeplab算法。
                      ├── unet.py #该文件表示的是PaddleSeg所支持的算法模型，这里表示unet算法。
                      └── ...
              ├── transforms #进行数据预处理的操作，包括各种数据增强策略
                      ├── functional.py
                      └── transforms.py
              └── utils
                      ├── config_check.py
                      ├── visualize.py
                      └── ...
     ├──  train.py  # 训练入口文件，该文件里描述了参数的解析，训练的启动方法，以及为训练准备的资源等。
     ├──  predict.py # 预测文件
     └── ...
</pre></div>
</div>
<ul class="simple">
<li><p>同学们还可以尝试使用PaddleSeg的API来自己开发，开发人员在使用pip install命令安装PaddleSeg后，仅需通过几行代码即可轻松实现图像分割模型的训练、评估和推理。 感兴趣的小伙伴们可以访问<a class="reference external" href="https://aistudio.baidu.com/aistudio/projectdetail/1339458?channelType=0&amp;channel=0">PaddleSeg动态图API使用教程</a></p></li>
</ul>
<p>PaddleSeg等各领域的开发套件已经为真正的工业实践提供了顶级方案，有国内的团队使用PaddleSeg的开发套件取得国际比赛的好成绩，可见开发套件提供的效果是State Of The Art的。</p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="install.html" class="btn btn-neutral float-right" title="PaddleSeg安装步骤" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="欢迎使用PaddleSeg！" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, liuzheng.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>